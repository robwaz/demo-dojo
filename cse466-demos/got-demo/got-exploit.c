#define _GNU_SOURCE
#include <unistd.h>
#include <stdio.h>
#include <stdint.h>
#include <dlfcn.h>
#include <link.h>
#include <elf.h>

uint64_t find_pltgot() {
    struct link_map *lm = NULL;
    void *self = dlopen(NULL, RTLD_NOW);
    dlinfo(self, RTLD_DI_LINKMAP, &lm);

    ElfW(Addr) pltgot = 0;
    for (ElfW(Dyn)* d = lm->l_ld; d->d_tag != DT_NULL; ++d)
        if (d->d_tag == DT_PLTGOT) { pltgot = d->d_un.d_ptr; break; }
    return pltgot;
}

void win() {
	printf("This is never called in the %s!", "program");
}

void main() {
	uint64_t got = find_pltgot();
	printf("The GOT.PLT is located at: %llx\n", got);
	printf("Win is located at: %p\n", win);
	int ret = read(0, (char *)got + 32, 8);
	printf("read returned: %d\n", ret);
	puts("goodbye!");
}
